<status-bar [color]="backgroundColor"></status-bar>


<ion-header class="ion-no-border">
  <ion-toolbar [color]="backgroundColor">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon color="light" slot="icon-only" name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-avatar slot="start">
      <div class="profile-img">
        <img *ngIf="anotherUser?.hasProfilePic" [src]="anotherUser?.profilePic" />
      </div>
    </ion-avatar>
    <ion-title>{{anotherUser?.name}}</ion-title>
  </ion-toolbar>
</ion-header>


<ion-content [scrollEvents]="true" (ionScroll)="logScrolling($event.detail)" color="primary">
  <ion-grid class="grid-messages" #grid (touchstart)="touchStart()" (touchend)="touchEnd()">
    <fiv-gallery #gallery [ambient]="false" (willOpen)="toggleImageVisibility(false, 300)" (didOpen)="didOpen()"
  (willClose)="willClose()" (didClose)="toggleImageVisibility(true)">

      <fiv-gallery-toolbar position="top">
        <ion-toolbar color="transparent">
          <ion-buttons slot="start">
            <ion-button (click)="gallery.close()">
              <ion-icon color="light" slot="icon-only" name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </fiv-gallery-toolbar>

      
      <ng-container *ngIf="messages; else emptyContent">
        <ng-container *ngFor="let message of (messages | objectToArray); let i = index">

          <ion-row *ngIf="message.id === firstNotReadedMessageId">
            <ion-col class="col-info" size="8">
              <div class="info">{{notReadedMessageText}}</div>
            </ion-col>
          </ion-row>
          
          <ion-row *ngIf="!onSameDay(i-1, i)">
            <ion-col class="col-info" size="8">
              <div class="info">
                {{ formatDate(message.timestamp, 'LL') }}
              </div>
            </ion-col>
          </ion-row>


          <ion-row class="row-messages">

            <ion-col class="col-message" size="9" [attr.offset]="message.fromMe ? '3': '0'">
              <div *ngIf="message.isText" class="div-message" [class]="backgroundColor" [class.fromMe]="message.fromMe">{{ message.text }}</div>
              <fiv-gallery-image *ngIf="message.isImage" [src]="message.url" [class]="backgroundColor" [class.fromMe]="message.fromMe"></fiv-gallery-image>
              <map-preview 
                *ngIf="message.isCoordinate"
                [coordinates]="message.coordinates"
                [id]="'message-location-' + message.id"
                [isAChatMessage]="true"
                [isMine]="message.fromMe"
                [address]="message.address"
                [color]="backgroundColor"
              ></map-preview>

            </ion-col>

            <ion-col size="2" [attr.offset]="message.fromMe ? '0': '3'">
              <div class="time">
                {{ formatDate(message.timestamp, 'HH:mm') }}
              </div>
            </ion-col>

          </ion-row>


        </ng-container>
      </ng-container>

      <ng-template #emptyContent>
        <empty-content image="conversation-empty" text="Solo tú puedes iniciar la conversación, ¡adelante!"></empty-content>
      </ng-template>

      <fiv-gallery-toolbar position="bottom">
        <ion-toolbar color="transparent">
          <div #bottomToolbar class="content">
            <div class="box">
              <ion-img *ngFor="let image of (messages | objectToArray | imageMessages); let i = index" [src]="image.url" class="img" (click)="goTo(i)"></ion-img>
            </div>
          </div>
        </ion-toolbar>
      </fiv-gallery-toolbar>

    </fiv-gallery>
  </ion-grid>
</ion-content>



<ion-footer class="footer-message-input">
  <ion-toolbar>
    <ion-row>
      <ion-col size="10.6" class="col-input">
        <ion-textarea rows="1" #textArea autosize [maxRows]="4" class="message-input" [(ngModel)]="newMessage">
        </ion-textarea>
      </ion-col>
      <ion-col size="1.4" class="col-button">
        <ion-button @button fill="clear" *ngIf="newMessage.length" (click)="sendText()" [color]="backgroundColor">
          <ion-icon slot="icon-only" name="send"></ion-icon>
        </ion-button>
      </ion-col>
      <div class="buttons">
        <ion-button @button class="location-button" fill="clear" *ngIf="!newMessage.length" color="medium" (click)="openMapToSendLocation()">
          <ion-icon slot="icon-only" name="location-outline"></ion-icon>
        </ion-button>
        <ion-button @button class="camera-button" fill="clear" *ngIf="!newMessage.length" color="medium" (click)="openImageSource()">
          <ion-icon slot="icon-only" name="camera-outline"></ion-icon>
        </ion-button>
      </div>
    </ion-row>
  </ion-toolbar>
</ion-footer>