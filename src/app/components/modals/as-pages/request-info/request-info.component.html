<status-bar [color]="backgroundColor"></status-bar>

<custom-header [title]="request.status ? 'Encargo ' + statusText[request.status] : 'Borrador'" [hideBorder]="true" color="light" [background]="backgroundColor">

  <ion-toolbar [color]="backgroundColor">
    <ion-buttons slot="start">
      <ion-button (click)="close()">
        <ion-icon slot="icon-only" name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ng-container *ngIf="request.isMine then optionsButton; else deleteButton"></ng-container>
      <ng-template #optionsButton>
        <ion-button (click)="presentOptions($event)">
          <ion-icon slot="icon-only" name="options"></ion-icon>
        </ion-button>
      </ng-template>
      <ng-template #deleteButton>
        <ion-button (click)="deleteRequest()">
          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
        </ion-button>
      </ng-template>
    </ion-buttons>
  </ion-toolbar>

</custom-header>


<ion-content [color]="backgroundColor" class="wrapper-ion-content" [scrollEvents]="true" (ionScroll)="scrollEvent($event.detail)">
  <ng-container *ngIf="request.isMine && request.status != requestStatus.draft then userView; else workerView"></ng-container>
  <ng-template #workerView><ng-container *ngTemplateOutlet="singlePage"></ng-container></ng-template>
  <ng-template #userView><ng-container *ngTemplateOutlet="tabs"></ng-container></ng-template>
</ion-content>


<ng-template #singlePage>
  <ion-content [scrollEvents]="true" (ionScroll)="propagateScroll($event)" class="ion-content-single-page">
    <div class="content ion-padding">

      <ion-list lines="none">
        <ng-container *ngTemplateOutlet="list1half"></ng-container>
        <ion-item *ngIf="request.images.length">
          <ion-label position="stacked" class="no-transform margin">
            <h2>Imágenes</h2>
          </ion-label>
          <gallery [images]="request.images"></gallery>
        </ion-item>
        <ng-container *ngTemplateOutlet="list2half"></ng-container>
      </ion-list>

    </div>
  </ion-content>
  <fab-with-text *ngIf="!request.isMine" iconName="chatbubble" text="Chatea" [collapsed]="collapsedFab" (clicked)="openConversation()">
    <div class="badge" [class.unread-messages]="request.unreadMesseages"></div>
  </fab-with-text>
</ng-template>


<ng-template #tabs>
  <super-tabs (tabChange)="scrollLastTabToTop($event)">
    <super-tabs-toolbar slot="top" [attr.no-border]="hideShadow ? '' : null">
      <super-tab-button disabled (click)="goToTab(0)">
        <ion-label>Respuestas</ion-label>
      </super-tab-button>
      <super-tab-button disabled (click)="goToTab(1)">
        <ion-label>Detalles</ion-label>
      </super-tab-button>
    </super-tabs-toolbar>
  
    <super-tabs-container autoScrollTop>
      <super-tab>
        <ion-content [scrollEvents]="true" (ionScroll)="propagateScroll($event)">
          <ng-container *ngIf="conversations | objectToArray | conversationFromThisRequest: request.id; else emptyContent">
            <conversation-list [currentRequest]="request"></conversation-list>
          </ng-container>
          <ng-template #emptyContent>
            <empty-content class="super-tabs" image="no-conversations" text="Aún sin respuestas"></empty-content>
          </ng-template>
        </ion-content>
      </super-tab>
      <super-tab>
        <ion-content [scrollEvents]="true" (ionScroll)="propagateScroll($event)">
          <div class="content ion-padding">

            <ion-list lines="none">
              <ng-container *ngTemplateOutlet="list1half"></ng-container>
              <ion-item *ngIf="request.images.length">
                <ion-label position="stacked" class="no-transform margin">
                  <h2>Imágenes</h2>
                </ion-label>
                <gallery [images]="request.images"></gallery>
              </ion-item>
              <ng-container *ngTemplateOutlet="list2half"></ng-container>
            </ion-list>

          </div>
        </ion-content>
      </super-tab>
    </super-tabs-container>
  </super-tabs>
</ng-template>


<ng-template #list1half>
  <ion-item>
    <ion-label>
      <h2>Encargo de</h2>
      <ng-container *ngIf="ownerName; else skeleton">
        <h3 class="ion-text-wrap">{{ownerName}}</h3>
      </ng-container>
      <ng-template #skeleton>
        <ion-skeleton-text animated style="width: 40%; margin: 20px 0 0 10px;"></ion-skeleton-text>
      </ng-template>
    </ion-label>
  </ion-item>

  <ion-item *ngIf="request.category">
    <ion-label>
      <h2>Busca</h2>
      <h3 class="ion-text-wrap">
        <span [upperCaseFirstLetter]="request.category"></span> - <span [upperCaseFirstLetter]="request.service"></span>
      </h3>
    </ion-label>
  </ion-item>

  <ion-item *ngIf="request.startDate">
    <ion-label>
      <h2>Para empezar</h2>
      <h3 class="ion-text-wrap" *ngIf="request.priority; else noPriority">
        Cuanto antes
      </h3>
      <ng-template #noPriority>
        <h3 class="ion-text-wrap">
          {{request.startDate.format('L')}} <span *ngIf="request.endDate">- {{request.endDate.format('L')}}</span>
        </h3>
      </ng-template>
    </ion-label>
  </ion-item>

  <ion-item *ngIf="request.title">
    <ion-label>
      <h2>Título</h2>
      <h3 class="ion-text-wrap">{{request.title}}</h3>
    </ion-label>
  </ion-item>

  <ion-item *ngIf="request.description">
    <ion-label position="stacked" class="no-transform margin">
      <h2>Descripción</h2>
    </ion-label>
    <ion-textarea color="primary" rows="1" autosize readonly type="text" [value]="request.description"></ion-textarea>
  </ion-item>
</ng-template>

<!-- Two parts due to the IVF gallery. can't inject its components if ion-content is inside ng-template -->

<ng-template #list2half>
  <ion-item *ngIf="request.budget">
    <ion-label>
      <h2>Presupuesto</h2>
      <h3 class="ion-text-wrap">{{request.budget}} €</h3>
    </ion-label>
  </ion-item>

  <ion-item *ngIf="request.coordinates">
    <ion-label>
      <h2>Ubicación</h2>
      <h3 class="break-spaces">{{request?.hideLocationAccuracy ? request?.addressCity: request?.addressFull}}</h3>
    </ion-label>
  </ion-item>

  <map-preview *ngIf="request.coordinates"
    [radiusKm]="request.hideLocationAccuracy ? 5 : 0"
    [coordinates]="request.coordinates"
    [hideMarker]="request.hideLocationAccuracy"
    [id]="request.id"
  ></map-preview>
</ng-template>